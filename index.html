<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Surveillance Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115; --panel: #151922; --muted: #9aa4b2; --text: #e6e8eb; --accent: #6b8cff;
            --warn: #ffc107; --crit: #ff4d4f; --ok: #2ecc71; --chip: #1f2430;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
        .app { display: grid; grid-template-rows: auto 1fr; min-height: 100vh; }
        .topbar { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: #0b0d12; border-bottom: 1px solid #1f2430; }
        .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; }
        .brand-badge { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 12px var(--accent); }
        .actions { display: flex; gap: 10px; }
        button, select { background: var(--panel); color: var(--text); border: 1px solid #232938; border-radius: 10px; padding: 10px 12px; cursor: pointer; }
        button:hover { border-color: #2b3244; }
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; padding: 16px; }
        .panel { background: var(--panel); border: 1px solid #1f2430; border-radius: 14px; padding: 12px; }
        .panel h3 { margin: 0 0 12px 0; font-size: 16px; color: var(--muted); font-weight: 600; }
        .live-wrap { position: relative; overflow: hidden; border-radius: 10px; }
        .live-wrap img, .live-wrap video { width: 100%; display: block; }
        .pill { display: inline-flex; align-items: center; gap: 6px; background: var(--chip); border: 1px solid #2a3142; color: var(--muted); padding: 6px 10px; border-radius: 999px; font-size: 12px; }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .alert-item { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 10px; border-radius: 10px; background: #191e2a; border: 1px solid #232938; }
        .badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; }
        .badge.crit { background: rgba(255,77,79,.12); color: #ff8082; border: 1px solid rgba(255,77,79,.25); }
        .badge.warn { background: rgba(255,193,7,.12); color: #ffd666; border: 1px solid rgba(255,193,7,.25); }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 10px; border-bottom: 1px solid #222838; text-align: left; color: var(--muted); font-size: 13px; }
        .controls { display: flex; gap: 8px; align-items: center; }
        .grid-analytics { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .muted { color: var(--muted); }
        .footer { padding: 10px 16px; color: var(--muted); border-top: 1px solid #1f2430; font-size: 12px; }
    </style>
    <script>
        async function fetchJSON(url) { const res = await fetch(url); return await res.json(); }
        function fmtTime(ts) { try { return new Date(ts).toLocaleString(); } catch(_) { return ts; } }
        function badge(sev) { return sev==='critical' ? 'crit' : 'warn'; }
    </script>
    </head>
<body>
    <div class="app">
        <div class="topbar">
            <div class="brand"><span class="brand-badge"></span> Smart Surveillance</div>
            <div class="actions">
                <select id="cameraSelect">
                    <option value="0">Camera 0</option>
                </select>
                <button id="startLive">Start Live</button>
                <button id="stopLive" disabled>Stop</button>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>Live Feed</h3>
                <div class="row" style="margin-bottom:10px;">
                    <span class="pill">Threshold <input id="liveThr" type="range" min="0" max="1" step="0.01" value="0.50" style="vertical-align:middle; margin:0 8px;"> <span id="liveThrVal">0.50</span></span>
                    <span class="pill">Seq <input id="liveSeq" type="number" min="4" max="32" step="1" value="16" style="width:70px; margin-left:6px;"></span>
                    <span class="pill">Tracking <input id="liveTracking" type="checkbox" checked style="margin-left:6px;"></span>
                </div>
                <div class="live-wrap">
                    <img id="liveImg" alt="Live stream will appear here" />
                </div>
            </div>
            <div class="panel">
                <h3>Alert Summary</h3>
                <div id="alertList" class="col" style="display:grid; gap:8px;"></div>
            </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="panel">
                <h3>Analytics</h3>
                <div class="grid-analytics">
                    <div>
                        <div id="trendChart" style="height:260px;"></div>
                    </div>
                    <div>
                        <div id="zoneChart" style="height:260px;"></div>
                    </div>
                </div>
            </div>
            <div class="panel">
                <h3>Event Log</h3>
                <div class="controls" style="margin-bottom:8px;">
                    <select id="filterType"><option value="">All Types</option><option value="loitering">Loitering</option><option value="boundary_cross">Boundary Crossing</option><option value="abandoned_object">Abandoned Object</option><option value="fall">Fall</option><option value="aggression">Aggression</option></select>
                    <select id="filterCam"><option value="">All Cameras</option><option>CAM-1</option><option>CAM-2</option><option>CAM-3</option></select>
                    <a class="pill" href="/api/export/events.csv">Export CSV</a>
                </div>
                <div style="overflow:auto; max-height:280px;">
                    <table class="table" id="eventTable">
                        <thead><tr><th>ID</th><th>Time</th><th>Camera</th><th>Type</th><th>Severity</th><th>Conf</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="panel">
                <h3>Upload & Analysis</h3>
                <div class="row" style="margin-bottom:10px;">
                    <label class="pill" for="uploadInput">Upload Video</label>
                    <input id="uploadInput" type="file" accept="video/*" style="background:#0b0d12; border:1px dashed #2a3142; padding:8px; border-radius:8px;" />
                    <span class="pill">Threshold <input id="upThr" type="range" min="0" max="1" step="0.01" value="0.50" style="vertical-align:middle; margin:0 8px;"> <span id="upThrVal">0.50</span></span>
                    <span class="pill">Max Frames <input id="upMaxFrames" type="number" min="16" max="500" step="1" value="100" style="width:90px; margin-left:8px;"></span>
                    <button id="runDetect" class="pill">Run Detect</button>
                </div>
                <div class="live-wrap" style="margin-bottom:10px;">
                    <video id="uploadedVideo" controls style="width:100%; display:none;"></video>
                </div>
                <div id="upStats" class="row" style="gap:12px; flex-wrap:wrap;"></div>
                <div id="upPlot" style="height:280px; margin-top:10px;"></div>
            </div>
            <div class="panel">
                <h3>Detected Anomalies</h3>
                <div id="upAnomalies" style="display:grid; gap:8px;"></div>
            </div>
        </div>

        <div class="panel" style="margin: 0 16px 16px;">
            <h3>Settings</h3>
            <div class="row">
                <span class="pill">Face Blur <input type="checkbox" style="margin-left:8px;"></span>
                <span class="pill">Loitering Threshold (s) <input type="number" value="30" min="5" max="600" style="width:80px; margin-left:8px;"></span>
                <span class="pill">Abandon Time (s) <input type="number" value="25" min="5" max="600" style="width:80px; margin-left:8px;"></span>
                <span class="pill">Push Alerts <input type="checkbox" checked style="margin-left:8px;"></span>
            </div>
        </div>

        <div class="footer">© Smart Surveillance — UI Dashboard (Frontend Only)</div>
    </div>

    <script>
        // Mock data for demo
        const mockAlerts = [
            { event_label: 'Loitering Detected', camera: 'CAM-1', timestamp: new Date().toISOString(), severity: 'warning', confidence: 0.87 },
            { event_label: 'Boundary Crossing', camera: 'CAM-2', timestamp: new Date(Date.now() - 300000).toISOString(), severity: 'critical', confidence: 0.92 },
            { event_label: 'Fall Detection', camera: 'CAM-3', timestamp: new Date(Date.now() - 600000).toISOString(), severity: 'critical', confidence: 0.95 },
            { event_label: 'Abandoned Object', camera: 'CAM-1', timestamp: new Date(Date.now() - 900000).toISOString(), severity: 'critical', confidence: 0.78 },
            { event_label: 'Aggression Alert', camera: 'CAM-2', timestamp: new Date(Date.now() - 1200000).toISOString(), severity: 'critical', confidence: 0.89 }
        ];

        const mockEvents = Array.from({length: 20}, (_, i) => ({
            id: `EVT-${1000+i}`,
            timestamp: new Date(Date.now() - i * 300000).toISOString(),
            camera: ['CAM-1', 'CAM-2', 'CAM-3'][i % 3],
            event_type: ['loitering', 'boundary_cross', 'abandoned_object', 'fall', 'aggression'][i % 5],
            event_label: ['Loitering', 'Boundary Crossing', 'Abandoned Object', 'Fall', 'Aggression'][i % 5],
            severity: ['critical', 'warning'][i % 2],
            confidence: 0.5 + Math.random() * 0.5
        }));

        // Live Controls
        const liveImg = document.getElementById('liveImg');
        const startBtn = document.getElementById('startLive');
        const stopBtn = document.getElementById('stopLive');
        const thrInput = document.getElementById('liveThr');
        const thrVal = document.getElementById('liveThrVal');
        const seqInput = document.getElementById('liveSeq');
        const trackingInput = document.getElementById('liveTracking');
        thrInput.addEventListener('input', ()=> thrVal.textContent = Number(thrInput.value).toFixed(2));
        let liveRunning = false;
        startBtn.addEventListener('click', ()=> {
            if (liveRunning) return;
            const thr = Number(thrInput.value);
            const seq = Number(seqInput.value);
            const tracking = trackingInput.checked;
            // Mock live feed - in real implementation this would connect to video_feed
            liveImg.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjQ4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1vY2sgTGl2ZSBGZWVkPC90ZXh0Pjwvc3ZnPg==';
            liveRunning = true;
            startBtn.disabled = true; stopBtn.disabled = false;
        });
        stopBtn.addEventListener('click', ()=> {
            liveImg.src = '';
            liveRunning = false;
            startBtn.disabled = false; stopBtn.disabled = true;
        });

        // Alerts
        function loadAlerts() {
            const wrap = document.getElementById('alertList');
            wrap.innerHTML = mockAlerts.map(a => `
                <div class="alert-item">
                    <div>
                        <div style="font-weight:600;">${a.event_label} — <span class="muted">${a.camera}</span></div>
                        <div class="muted" style="font-size:12px;">${fmtTime(a.timestamp)}</div>
                    </div>
                    <div class="badge ${badge(a.severity)}">${Math.round(a.confidence*100)}%</div>
                </div>
            `).join('');
        }

        // Trends
        function loadTrends() {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const traces = [
                { x: days, y: [3, 7, 2, 8, 5, 1, 4], type: 'scatter', mode: 'lines+markers', name: 'Loitering', line: {color: '#ffc107'} },
                { x: days, y: [1, 2, 0, 3, 1, 0, 2], type: 'scatter', mode: 'lines+markers', name: 'Boundary Crossing', line: {color: '#ff4d4f'} },
                { x: days, y: [2, 1, 1, 4, 2, 1, 3], type: 'scatter', mode: 'lines+markers', name: 'Fall Detection', line: {color: '#dc3545'} },
                { x: days, y: [1, 3, 0, 2, 1, 0, 1], type: 'scatter', mode: 'lines+markers', name: 'Aggression', line: {color: '#fd7e14'} }
            ];
            Plotly.newPlot('trendChart', traces, { 
                paper_bgcolor: 'rgba(0,0,0,0)', 
                plot_bgcolor: 'rgba(0,0,0,0)', 
                font: {color: '#e6e8eb'}, 
                margin: {t: 10, l: 30, r: 10, b: 30},
                legend: {font: {size: 10}}
            });
        }

        // Zones
        function loadZones() {
            const zones = ['Zone 1', 'Zone 2', 'Zone 3', 'Entry', 'Exit'];
            const counts = [15, 8, 12, 5, 3];
            Plotly.newPlot('zoneChart', [{ 
                x: zones, 
                y: counts, 
                type: 'bar',
                marker: {color: '#6b8cff'}
            }], { 
                paper_bgcolor: 'rgba(0,0,0,0)', 
                plot_bgcolor: 'rgba(0,0,0,0)', 
                font: {color: '#e6e8eb'}, 
                margin: {t: 10, l: 30, r: 10, b: 30} 
            });
        }

        // Events
        function loadEvents() {
            const tbody = document.querySelector('#eventTable tbody');
            tbody.innerHTML = mockEvents.map(e => `
                <tr>
                    <td>${e.id}</td>
                    <td>${fmtTime(e.timestamp)}</td>
                    <td>${e.camera}</td>
                    <td>${e.event_label}</td>
                    <td>${e.severity}</td>
                    <td>${Math.round(e.confidence*100)}%</td>
                </tr>
            `).join('');
        }

        document.getElementById('filterType').addEventListener('change', loadEvents);
        document.getElementById('filterCam').addEventListener('change', loadEvents);

        // Upload & Detect (Mock)
        const uploadInput = document.getElementById('uploadInput');
        const uploadedVideo = document.getElementById('uploadedVideo');
        const upThr = document.getElementById('upThr');
        const upThrVal = document.getElementById('upThrVal');
        const upMaxFrames = document.getElementById('upMaxFrames');
        const runDetect = document.getElementById('runDetect');
        const upStats = document.getElementById('upStats');
        const upPlotDiv = document.getElementById('upPlot');
        const upAnomalies = document.getElementById('upAnomalies');
        upThr.addEventListener('input', ()=> upThrVal.textContent = Number(upThr.value).toFixed(2));

        uploadInput.addEventListener('change', (e)=>{
            if (!e.target.files || e.target.files.length===0) return;
            const file = e.target.files[0];
            const url = URL.createObjectURL(file);
            uploadedVideo.src = url; 
            uploadedVideo.style.display = 'block';
        });

        runDetect.addEventListener('click', ()=>{
            if (!uploadedVideo.src) { alert('Please upload a video first'); return; }
            upStats.innerHTML = 'Running detection...';
            upAnomalies.innerHTML = '';
            upPlotDiv.innerHTML = '';
            
            // Mock detection results
            setTimeout(() => {
                upStats.innerHTML = `
                    <span class="pill">Seq: 11</span>
                    <span class="pill">Anom (sel): 2</span>
                    <span class="pill">Anom 0.4: 4</span>
                    <span class="pill">Anom 0.5: 2</span>
                    <span class="pill">Anom 0.6: 1</span>
                    <span class="pill">Frames: 100</span>
                    <span class="pill">FPS: 25.0</span>
                `;
                
                // Mock plot
                const times = Array.from({length: 11}, (_, i) => i * 2.5);
                const probs = Array.from({length: 11}, () => 0.3 + Math.random() * 0.4);
                const trace = { x: times, y: probs, type: 'scatter', mode: 'markers', name: 'Anomaly Probability', marker: {color: probs.map(p => p > 0.5 ? '#ff4d4f' : '#6b8cff')} };
                Plotly.newPlot(upPlotDiv, [trace], { 
                    paper_bgcolor: 'rgba(0,0,0,0)', 
                    plot_bgcolor: 'rgba(0,0,0,0)', 
                    font: {color: '#e6e8eb'}, 
                    margin: {t: 10, l: 30, r: 10, b: 30},
                    title: 'Anomaly Detection Timeline'
                });
                
                // Mock anomalies
                upAnomalies.innerHTML = `
                    <div class="alert-item">
                        <div>
                            <div style="font-weight:600;">Sequence 3</div>
                            <div class="muted" style="font-size:12px;">7.5s – 10.0s</div>
                        </div>
                        <div class="badge crit">78%</div>
                    </div>
                    <div class="alert-item">
                        <div>
                            <div style="font-weight:600;">Sequence 7</div>
                            <div class="muted" style="font-size:12px;">17.5s – 20.0s</div>
                        </div>
                        <div class="badge crit">85%</div>
                    </div>
                `;
            }, 1500);
        });

        // Initial loads
        loadAlerts(); 
        loadTrends(); 
        loadZones(); 
        loadEvents();
        setInterval(loadAlerts, 10000);
    </script>
</body>
</html>
